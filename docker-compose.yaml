services:
  polaris-db:
    image: postgres:16-alpine
    container_name: polaris-db
    environment:
      - POSTGRES_USER=polaris
      - POSTGRES_PASSWORD=polaris_password
      - POSTGRES_DB=polaris
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U polaris -d polaris"]
      interval: 5s
      timeout: 5s
      retries: 5

  # NEW: One-shot service to create the schema and bootstrap the realm
  polaris-bootstrap:
    image: apache/polaris-admin-tool:latest
    container_name: polaris-bootstrap
    depends_on:
      polaris-db:
        condition: service_healthy
    environment:
      - POLARIS_PERSISTENCE_TYPE=relational-jdbc
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://polaris-db:5432/polaris
      - QUARKUS_DATASOURCE_USERNAME=polaris
      - QUARKUS_DATASOURCE_PASSWORD=polaris_password
      - QUARKUS_DATASOURCE_DB_KIND=postgresql
    command: >
      bootstrap -r default-realm -c default-realm,root,secret

  polaris:
    image: apache/polaris:latest
    container_name: polaris
    depends_on:
      polaris-bootstrap:
        condition: service_completed_successfully
    ports:
      - "8181:8181"
    environment:
      - POLARIS_SKIP_CREDENTIAL_SUBSCOPING_INDIRECTION=true
      - POLARIS_PERSISTENCE_TYPE=relational-jdbc
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:postgresql://polaris-db:5432/polaris
      - QUARKUS_DATASOURCE_USERNAME=polaris
      - QUARKUS_DATASOURCE_PASSWORD=polaris_password
      - QUARKUS_DATASOURCE_DB_KIND=postgresql
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - POLARIS_REALM_CONTEXT_REALMS=default-realm
      - POLARIS_FEATURES_ALLOW_TABLE_LOCATION_OVERLAP=true

  minio:
    image: minio/minio
    container_name: minio
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
    ports: ["9000:9000", "9001:9001"]
    command: server /data --console-address ":9001"